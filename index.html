<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è©¦åˆãƒ­ã‚°å…¥åŠ›</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', sans-serif;
    background: #f0f2f5;
    color: #1a1a1a;
    padding: 12px;
    max-width: 480px;
    margin: 0 auto;
  }
  h1 { font-size: 18px; text-align: center; padding: 12px 0; color: #333; }

  .card {
    background: #fff; border-radius: 12px; padding: 16px;
    margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  .card-title {
    font-size: 14px; font-weight: 700; color: #555;
    margin-bottom: 12px; display: flex; align-items: center; gap: 6px;
  }

  label {
    display: block; font-size: 12px; font-weight: 600;
    color: #777; margin-bottom: 4px; margin-top: 10px;
  }
  label:first-child { margin-top: 0; }

  input[type="text"], input[type="date"], input[type="number"], select {
    width: 100%; padding: 10px 12px; border: 1.5px solid #ddd;
    border-radius: 8px; font-size: 16px; background: #fafafa;
    transition: border-color 0.2s; -webkit-appearance: none;
  }
  input:focus, select:focus { outline: none; border-color: #4a90d9; background: #fff; }

  .chip-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
  .chip {
    padding: 8px 14px; border: 2px solid #ddd; border-radius: 8px;
    font-size: 14px; font-weight: 600; cursor: pointer; user-select: none;
    background: #fafafa; transition: all 0.15s; -webkit-tap-highlight-color: transparent;
  }
  .chip.active { background: #4a90d9; color: #fff; border-color: #4a90d9; }

  /* Player chips - name display */
  .player-grid { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 6px; }
  .player-chip {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-width: 48px; height: 44px; padding: 2px 6px;
    border: 2px solid #ddd; border-radius: 8px;
    cursor: pointer; user-select: none; background: #fafafa;
    transition: all 0.15s; -webkit-tap-highlight-color: transparent;
  }
  .player-chip .pname { font-size: 12px; font-weight: 700; line-height: 1.2; }
  .player-chip .pnum { font-size: 9px; color: #999; line-height: 1; }
  .player-chip.selected { background: #4a90d9; color: #fff; border-color: #4a90d9; }
  .player-chip.selected .pnum { color: rgba(255,255,255,0.7); }
  .player-chip.gk { background: #f59e0b; color: #fff; border-color: #f59e0b; }
  .player-chip.gk .pnum { color: rgba(255,255,255,0.7); }

  .player-count {
    display: inline-block; background: #4a90d9; color: #fff;
    font-size: 12px; font-weight: 700; padding: 2px 8px;
    border-radius: 10px; margin-left: 6px;
  }

  .gk-row { margin-top: 8px; display: flex; align-items: center; gap: 8px; }
  .gk-row label { margin: 0; white-space: nowrap; }
  .gk-row select { flex: 1; }

  /* Score dropdown */
  .score-row {
    display: flex; align-items: center; gap: 8px;
    justify-content: center; margin-top: 6px;
  }
  .score-select {
    width: 70px !important; text-align: center; text-align-last: center;
    font-size: 22px !important; font-weight: 700; padding: 8px 4px !important;
  }
  .score-divider { font-size: 24px; font-weight: 700; color: #999; }
  .result-badge {
    font-size: 20px; font-weight: 900; width: 36px; height: 36px;
    border-radius: 50%; display: flex; align-items: center;
    justify-content: center; flex-shrink: 0;
  }
  .result-badge.win { background: #e8f5e9; color: #2e7d32; }
  .result-badge.draw { background: #fff8e1; color: #f57f17; }
  .result-badge.lose { background: #fce4ec; color: #c62828; }
  .result-badge.none { background: #f5f5f5; color: #bbb; }

  /* Scorer */
  .scorer-grid { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 6px; }
  .scorer-chip {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-width: 48px; height: 38px; padding: 2px 8px;
    border: 2px solid #ddd; border-radius: 8px;
    font-size: 12px; font-weight: 600; cursor: pointer; user-select: none;
    background: #fafafa; transition: all 0.15s; -webkit-tap-highlight-color: transparent;
  }
  .scorer-chip.selected { background: #e74c3c; color: #fff; border-color: #e74c3c; }
  .scorer-chip .count { font-size: 10px; opacity: 0.9; }
  .hint { font-size: 11px; color: #aaa; margin-top: 4px; line-height: 1.4; }

  /* Substitution */
  .sub-section { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e0e0e0; }
  .sub-toggle {
    font-size: 13px; color: #4a90d9; cursor: pointer;
    font-weight: 600; -webkit-tap-highlight-color: transparent;
  }
  .sub-content { margin-top: 8px; }
  .sub-mode-tabs {
    display: flex; margin-bottom: 10px; border-radius: 8px;
    overflow: hidden; border: 2px solid #4a90d9;
  }
  .sub-mode-tab {
    flex: 1; padding: 8px; text-align: center; font-size: 12px; font-weight: 700;
    cursor: pointer; background: #fff; color: #4a90d9;
    transition: all 0.15s; -webkit-tap-highlight-color: transparent;
  }
  .sub-mode-tab.active { background: #4a90d9; color: #fff; }
  .sub-row {
    display: flex; align-items: center; gap: 6px;
    margin-bottom: 8px; background: #f8f9fa; padding: 10px 8px; border-radius: 8px;
  }
  .sub-row select { flex: 1; padding: 8px; font-size: 14px; font-weight: 700; }
  .sub-arrow { font-size: 18px; font-weight: 700; color: #4a90d9; flex-shrink: 0; }
  .sub-remove {
    width: 28px; height: 28px; border: none; background: #fee; color: #e74c3c;
    border-radius: 6px; font-size: 16px; font-weight: 700; cursor: pointer;
    flex-shrink: 0; display: flex; align-items: center; justify-content: center;
  }
  .sub-gk-change {
    margin-top: 8px; padding: 8px; background: #fff8e1; border-radius: 8px;
    display: flex; align-items: center; gap: 8px;
  }
  .sub-gk-change label { margin: 0; font-size: 12px; color: #f59e0b; font-weight: 700; white-space: nowrap; }
  .sub-gk-change select { flex: 1; font-size: 14px; padding: 8px; }

  /* Opponent per match */
  .opp-section { margin-top: 8px; }
  .opp-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
  .opp-chip {
    padding: 6px 12px; border: 2px solid #ddd; border-radius: 8px;
    font-size: 13px; font-weight: 600; cursor: pointer; background: #fafafa;
    transition: all 0.15s; -webkit-tap-highlight-color: transparent;
    max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .opp-chip.active { background: #4a90d9; color: #fff; border-color: #4a90d9; }
  .opp-input-row { margin-top: 6px; }

  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 4px;
    padding: 10px 16px; border: none; border-radius: 8px;
    font-size: 14px; font-weight: 600; cursor: pointer;
    transition: all 0.15s; -webkit-tap-highlight-color: transparent;
  }
  .btn-primary { background: #4a90d9; color: #fff; width: 100%; padding: 14px; font-size: 16px; }
  .btn-primary:active { background: #3a7bc8; }
  .btn-secondary { background: #e8ecf1; color: #555; width: 100%; padding: 12px; }
  .btn-secondary:active { background: #d8dce1; }
  .btn-danger { background: #fee; color: #e74c3c; font-size: 12px; padding: 6px 12px; }
  .btn-add-sub { background: #e8f4fd; color: #4a90d9; font-size: 13px; padding: 8px 14px; width: 100%; }

  .match-header { display: flex; justify-content: space-between; align-items: center; }
  .match-number { font-size: 16px; font-weight: 700; color: #4a90d9; }

  .format-presets { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
  .format-chip {
    padding: 7px 12px; border: 2px solid #ddd; border-radius: 8px;
    font-size: 13px; font-weight: 600; cursor: pointer; background: #fafafa;
    transition: all 0.15s; -webkit-tap-highlight-color: transparent;
  }
  .format-chip.active { background: #4a90d9; color: #fff; border-color: #4a90d9; }
  .format-custom {
    display: flex; align-items: center; gap: 4px; margin-top: 8px;
  }
  .format-custom input { width: 55px !important; text-align: center; }
  .format-custom span { font-size: 14px; font-weight: 600; color: #555; }

  #output-area {
    background: #1a1a2e; color: #e0e0e0; border-radius: 12px; padding: 16px;
    font-family: monospace; font-size: 13px; white-space: pre-wrap;
    word-break: break-all; line-height: 1.6; margin-top: 12px; display: none;
  }
  .copy-success {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8); color: #fff; padding: 16px 32px;
    border-radius: 12px; font-size: 16px; font-weight: 600;
    z-index: 100; animation: fadeOut 1.5s ease forwards;
  }
  @keyframes fadeOut { 0%, 60% { opacity: 1; } 100% { opacity: 0; } }

  .roster-input-row { display: flex; gap: 6px; margin-top: 8px; }
  .roster-input-row input { flex: 1; }
  .roster-input-row .btn { flex-shrink: 0; width: auto; }
  .roster-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
  .roster-tag {
    display: inline-flex; align-items: center; gap: 4px;
    background: #e8ecf1; border-radius: 6px; padding: 4px 8px;
    font-size: 13px; font-weight: 600;
  }
  .roster-tag .remove { cursor: pointer; color: #999; font-size: 16px; line-height: 1; }
</style>
</head>
<body>

<h1>âš½ è©¦åˆãƒ­ã‚°å…¥åŠ›</h1>

<!-- Basic Info -->
<div class="card">
  <div class="card-title"><span>ğŸ“‹</span> åŸºæœ¬æƒ…å ±</div>
  <label>æ—¥ä»˜</label>
  <input type="date" id="match-date">

  <label>è©¦åˆç¨®åˆ¥</label>
  <div class="chip-grid" id="match-type-options">
    <div class="chip active" data-val="TM">TM</div>
    <div class="chip" data-val="å…¬å¼æˆ¦">å…¬å¼æˆ¦</div>
    <div class="chip" data-val="ã‚«ãƒƒãƒ—æˆ¦">ã‚«ãƒƒãƒ—æˆ¦</div>
    <div class="chip" data-val="ãƒªãƒ¼ã‚°æˆ¦">ãƒªãƒ¼ã‚°æˆ¦</div>
  </div>

  <label>å¤§ä¼šåï¼ˆä»»æ„ï¼‰</label>
  <input type="text" id="tournament-name" placeholder="ä¾‹: ANTLERS CUP 2025">

  <label>ä¼šå ´</label>
  <input type="text" id="venue" placeholder="ä¾‹: SFAãƒ•ãƒƒãƒˆãƒœãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼">

  <label>è©¦åˆå½¢å¼</label>
  <div class="format-presets" id="format-presets">
    <div class="format-chip active" data-min="15" data-per="1">15åˆ†Ã—1æœ¬</div>
    <div class="format-chip" data-min="15" data-per="2">15åˆ†ãƒãƒ¼ãƒ•</div>
    <div class="format-chip" data-min="20" data-per="2">20åˆ†ãƒãƒ¼ãƒ•</div>
    <div class="format-chip" data-min="" data-per="">ã‚«ã‚¹ã‚¿ãƒ </div>
  </div>
  <div class="format-custom" id="format-custom" style="display:none;">
    <input type="number" id="match-minutes" value="15" min="1" max="90">
    <span>åˆ† Ã—</span>
    <input type="number" id="match-halves" value="1" min="1" max="4">
    <span>æœ¬</span>
  </div>
</div>

<!-- Roster -->
<div class="card">
  <div class="card-title"><span>ğŸ‘•</span> ç™»éŒ²ãƒ¡ãƒ³ãƒãƒ¼</div>
  <p style="font-size:12px;color:#999;margin-bottom:6px;">å„è©¦åˆã®é¸æ‰‹é¸æŠã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
  <div class="roster-tags" id="roster-tags"></div>
  <div class="roster-input-row">
    <input type="number" id="roster-num" placeholder="èƒŒç•ªå·" min="1" max="99" style="width:70px;">
    <input type="text" id="roster-name" placeholder="åå‰ï¼ˆä¸‹ã®åå‰ï¼‰">
    <button class="btn btn-secondary" onclick="addRosterPlayer()" style="padding:8px 12px;">è¿½åŠ </button>
  </div>
</div>

<!-- Matches -->
<div id="matches-container"></div>

<button class="btn btn-secondary" onclick="addMatch()" style="margin-bottom:12px;">ï¼‹ è©¦åˆã‚’è¿½åŠ </button>
<button class="btn btn-primary" onclick="generateOutput()">ğŸ“ ãƒ­ã‚°ã‚’ç”Ÿæˆ</button>

<pre id="output-area"></pre>
<button class="btn btn-primary" id="copy-btn" onclick="copyOutput()" style="display:none;margin-top:8px;background:#27ae60;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>

<div style="height:40px;"></div>

<script>
// ========== State ==========
const DEFAULT_ROSTER = [
  {num:1,name:'è³¢äºº'},{num:2,name:'å„ªè–'},{num:3,name:'æ—ºä½‘'},{num:4,name:'ä¸€ç¿”'},
  {num:6,name:'è’¼æ±°æœ—'},{num:7,name:'éš¼è¼”'},{num:8,name:'è‘µ'},{num:9,name:'ç‰çœŸ'},
  {num:10,name:'é›…ç©º'},{num:13,name:'å¤©'},{num:14,name:'å€­'},{num:15,name:'å†¬æ‚Ÿ'},
  {num:16,name:'ç§‹å®Ÿ'},{num:17,name:'æ…§'},{num:18,name:'é¢¨é›…'},{num:19,name:'é™½å¤ª'},
  {num:20,name:'æ…å£«éƒ'},{num:22,name:'è‘µæ±°'},{num:24,name:'è’¼ä¹‹'},{num:28,name:'ç„¶'}
];

let roster = []; // {num, name}[]
let matches = [];
let matchCounter = 0;
let formatMinutes = 15;
let formatPeriods = 1;

function getName(num) {
  const p = roster.find(r => r.num === num);
  return p ? p.name : String(num);
}

function getLabel(num) {
  const p = roster.find(r => r.num === num);
  return p ? `${p.name}(${num})` : String(num);
}

// ========== Init ==========
function init() {
  document.getElementById('match-date').value = new Date().toISOString().slice(0,10);

  // Load roster (migrate from old format if needed)
  const saved = localStorage.getItem('soccer-roster-v2');
  if (saved) {
    roster = JSON.parse(saved);
  } else {
    const old = localStorage.getItem('soccer-roster');
    if (old) {
      const nums = JSON.parse(old);
      if (nums.length > 0 && typeof nums[0] === 'number') {
        roster = nums.map(n => {
          const def = DEFAULT_ROSTER.find(d => d.num === n);
          return def || {num: n, name: String(n)};
        });
      } else {
        roster = DEFAULT_ROSTER.slice();
      }
    } else {
      roster = DEFAULT_ROSTER.slice();
    }
  }
  renderRoster();

  // Match type chips
  document.querySelectorAll('#match-type-options .chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('#match-type-options .chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
    });
  });

  // Format presets
  document.querySelectorAll('#format-presets .format-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('#format-presets .format-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      if (chip.dataset.min && chip.dataset.per) {
        formatMinutes = parseInt(chip.dataset.min);
        formatPeriods = parseInt(chip.dataset.per);
        document.getElementById('format-custom').style.display = 'none';
      } else {
        document.getElementById('format-custom').style.display = 'flex';
      }
    });
  });
  document.getElementById('match-minutes').addEventListener('input', function() { formatMinutes = parseInt(this.value)||15; });
  document.getElementById('match-halves').addEventListener('input', function() { formatPeriods = parseInt(this.value)||1; });

  document.getElementById('roster-name').addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); addRosterPlayer(); }
  });

  addMatch();
}

// ========== Roster ==========
function renderRoster() {
  roster.sort((a,b) => a.num - b.num);
  document.getElementById('roster-tags').innerHTML = roster.map(r =>
    `<span class="roster-tag">${r.name}(${r.num})<span class="remove" onclick="removeRosterPlayer(${r.num})">Ã—</span></span>`
  ).join('');
  localStorage.setItem('soccer-roster-v2', JSON.stringify(roster));
  matches.forEach(m => renderMatchPlayers(m.id));
}

function addRosterPlayer() {
  const numInput = document.getElementById('roster-num');
  const nameInput = document.getElementById('roster-name');
  const num = parseInt(numInput.value);
  const name = nameInput.value.trim();
  if (!num || num < 1 || !name) return;
  if (!roster.find(r => r.num === num)) {
    roster.push({num, name});
    renderRoster();
  }
  numInput.value = '';
  nameInput.value = '';
  numInput.focus();
}

function removeRosterPlayer(num) {
  roster = roster.filter(r => r.num !== num);
  renderRoster();
}

// ========== Matches ==========
function getMatch(id) { return matches.find(m => m.id === id); }

function getUsedOpponents() {
  const opps = [];
  matches.forEach(m => { if (m.opponent && !opps.includes(m.opponent)) opps.push(m.opponent); });
  return opps;
}

function addMatch() {
  matchCounter++;
  const prevOpp = matches.length > 0 ? matches[matches.length - 1].opponent : '';
  const match = {
    id: matchCounter,
    opponent: prevOpp,
    oppMode: prevOpp ? 'prev' : 'new', // 'prev' or 'new'
    players: [],
    gk: null,
    scoreUs: 0,
    scoreOpponent: 0,
    scorers: {},
    showSub: false,
    subMode: 'individual',
    subs: [],
    subGkChange: null,
    swapPlayers: [],
    swapGk: null,
    memo: ''
  };
  matches.push(match);
  renderMatch(match);
}

function removeMatch(id) {
  matches = matches.filter(m => m.id !== id);
  document.getElementById(`match-${id}`).remove();
  renumberMatches();
}

function renumberMatches() {
  document.querySelectorAll('.match-card').forEach((card, i) => {
    card.querySelector('.match-number').textContent = `ç¬¬${i+1}è©¦åˆ`;
  });
}

function renderMatch(match) {
  const div = document.createElement('div');
  div.className = 'card match-card';
  div.id = `match-${match.id}`;
  const idx = matches.indexOf(match) + 1;
  const mid = match.id;

  // Score options
  const scoreOpts = Array.from({length:11}, (_,i) => i)
    .map(i => `<option value="${i}">${i}</option>`).join('');

  div.innerHTML = `
    <div class="match-header">
      <span class="match-number">ç¬¬${idx}è©¦åˆ</span>
      <button class="btn btn-danger" onclick="removeMatch(${mid})">å‰Šé™¤</button>
    </div>

    <div class="opp-section">
      <label>å¯¾æˆ¦ç›¸æ‰‹</label>
      <div id="opp-area-${mid}"></div>
    </div>

    <label>
      å‡ºå ´é¸æ‰‹ï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠ / é•·æŠ¼ã—ã§GKï¼‰
      <span class="player-count" id="pcount-${mid}">0äºº</span>
    </label>
    <div class="player-grid" id="players-${mid}"></div>
    <div class="gk-row">
      <label style="font-size:13px;color:#f59e0b;font-weight:700;">GK:</label>
      <select id="gk-${mid}" onchange="setGk(${mid},this.value)"><option value="">é¸æŠ</option></select>
    </div>

    <div class="sub-section">
      <span class="sub-toggle" id="sub-toggle-${mid}" onclick="toggleSub(${mid})">ï¼‹ äº¤ä»£ã‚’å…¥åŠ›</span>
      <div class="sub-content" id="sub-${mid}" style="display:none;">
        <div class="sub-mode-tabs">
          <div class="sub-mode-tab active" data-mode="individual" onclick="setSubMode(${mid},'individual')">å€‹åˆ¥äº¤ä»£</div>
          <div class="sub-mode-tab" data-mode="fullswap" onclick="setSubMode(${mid},'fullswap')">ç·å…¥æ›¿ãˆ</div>
        </div>
        <div id="sub-individual-${mid}">
          <div id="sub-rows-${mid}"></div>
          <button class="btn btn-add-sub" onclick="addSubRow(${mid})">ï¼‹ äº¤ä»£ã‚’è¿½åŠ </button>
          <div class="sub-gk-change" id="sub-gk-area-${mid}" style="display:none;">
            <label>GKå¤‰æ›´â†’</label>
            <select id="sub-gk-change-${mid}" onchange="setSubGkChange(${mid},this.value)">
              <option value="">å¤‰æ›´ãªã—</option>
            </select>
          </div>
        </div>
        <div id="sub-fullswap-${mid}" style="display:none;">
          <label>äº¤ä»£å¾Œã®å…¨ãƒ¡ãƒ³ãƒãƒ¼
            <span class="player-count" id="swapcount-${mid}">0äºº</span>
          </label>
          <div class="player-grid" id="swap-players-${mid}"></div>
          <div class="gk-row">
            <label style="font-size:13px;color:#f59e0b;font-weight:700;">GK:</label>
            <select id="swap-gk-${mid}" onchange="setSwapGk(${mid},this.value)"><option value="">é¸æŠ</option></select>
          </div>
        </div>
      </div>
    </div>

    <label>ã‚¹ã‚³ã‚¢ï¼ˆè‡ªãƒãƒ¼ãƒ  - ç›¸æ‰‹ï¼‰</label>
    <div class="score-row">
      <select class="score-select" id="score-us-${mid}" onchange="updateScore(${mid})">${scoreOpts}</select>
      <span class="score-divider">-</span>
      <select class="score-select" id="score-opp-${mid}" onchange="updateScore(${mid})">${scoreOpts}</select>
      <div class="result-badge none" id="result-${mid}">-</div>
    </div>

    <label>å¾—ç‚¹è€…</label>
    <div class="hint">ã‚¿ãƒƒãƒ—: +1ç‚¹ ï¼ é•·æŠ¼ã—: ãƒªã‚»ãƒƒãƒˆ</div>
    <div class="scorer-grid" id="scorers-${mid}">
      <span style="font-size:12px;color:#999;">å…ˆã«å‡ºå ´é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
    </div>

    <div style="margin-top:8px;">
      <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="memo-${mid}" placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°" oninput="getMatch(${mid}).memo=this.value">
    </div>
  `;

  document.getElementById('matches-container').appendChild(div);
  renderOppArea(mid);
  renderMatchPlayers(mid);
}

// ========== Opponent per match ==========
function renderOppArea(matchId) {
  const m = getMatch(matchId);
  const area = document.getElementById(`opp-area-${matchId}`);
  const idx = matches.indexOf(m);

  // Collect unique opponents from previous matches
  const prevOpps = [];
  for (let i = 0; i < idx; i++) {
    if (matches[i].opponent && !prevOpps.includes(matches[i].opponent)) {
      prevOpps.push(matches[i].opponent);
    }
  }

  if (prevOpps.length === 0) {
    // First match or no previous opponents - just text input
    area.innerHTML = `<input type="text" id="opp-input-${matchId}" placeholder="ä¾‹: ã‚¨ã‚¯ã‚»ãƒ¬ãƒ³ãƒˆãƒ•ã‚£ãƒ¼ãƒˆ"
      value="${m.opponent || ''}" oninput="setOpp(${matchId},this.value)">`;
  } else {
    // Show previous opponents as chips + new input option
    const isNew = !prevOpps.includes(m.opponent);
    area.innerHTML = `
      <div class="opp-chips">
        ${prevOpps.map(o => `<div class="opp-chip ${m.opponent===o && !isNew?'active':''}"
          onclick="selectOpp(${matchId},'${o.replace(/'/g,"\\'")}')">${o}</div>`).join('')}
        <div class="opp-chip ${isNew?'active':''}" onclick="selectOppNew(${matchId})">åˆ¥ã®ç›¸æ‰‹</div>
      </div>
      <div class="opp-input-row" id="opp-new-row-${matchId}" style="display:${isNew?'block':'none'};">
        <input type="text" id="opp-input-${matchId}" placeholder="ç›¸æ‰‹ãƒãƒ¼ãƒ å"
          value="${isNew ? (m.opponent||'') : ''}" oninput="setOpp(${matchId},this.value)">
      </div>`;
  }
}

function selectOpp(matchId, opp) {
  const m = getMatch(matchId);
  m.opponent = opp;
  m.oppMode = 'prev';
  renderOppArea(matchId);
}

function selectOppNew(matchId) {
  const m = getMatch(matchId);
  m.oppMode = 'new';
  m.opponent = '';
  renderOppArea(matchId);
  const input = document.getElementById(`opp-input-${matchId}`);
  if (input) input.focus();
}

function setOpp(matchId, val) {
  getMatch(matchId).opponent = val;
}

// ========== Player selection ==========
function renderMatchPlayers(matchId) {
  const m = getMatch(matchId);
  if (!m) return;
  const grid = document.getElementById(`players-${matchId}`);
  if (!grid) return;

  const sorted = [...roster].sort((a,b) => a.num - b.num);
  grid.innerHTML = sorted.map(r => {
    const isGk = m.gk === r.num;
    const isSel = m.players.includes(r.num);
    let cls = 'player-chip';
    if (isGk) cls += ' gk';
    else if (isSel) cls += ' selected';
    const label = isGk ? `<span class="pname">GK ${r.name}</span><span class="pnum">${r.num}</span>`
                       : `<span class="pname">${r.name}</span><span class="pnum">${r.num}</span>`;
    return `<div class="${cls}"
      onclick="togglePlayer(${matchId},${r.num},false)"
      oncontextmenu="event.preventDefault();togglePlayer(${matchId},${r.num},true)"
      ontouchstart="lpStart(event,${matchId},${r.num},'fp')"
      ontouchend="lpEnd(event)" ontouchmove="lpEnd(event)"
    >${label}</div>`;
  }).join('');

  const total = m.players.length + (m.gk ? 1 : 0);
  const c = document.getElementById(`pcount-${matchId}`);
  if (c) c.textContent = `${total}äºº`;

  updateGkSelect(matchId);
  renderScorers(matchId);
  updateSubDropdowns(matchId);
  renderSwapPlayers(matchId);
}

// Long press
let lpTimer = null, lpFired = false;
function lpStart(e, mid, num, type) {
  lpFired = false;
  lpTimer = setTimeout(() => {
    lpFired = true;
    if (type === 'fp') togglePlayer(mid, num, true);
    else if (type === 'sw') toggleSwapPlayer(mid, num, true);
    else if (type === 'sc') resetScorer(mid, num);
  }, 500);
}
function lpEnd() { if (lpTimer) { clearTimeout(lpTimer); lpTimer = null; } }

function togglePlayer(matchId, num, asGk) {
  if (lpFired && !asGk) return;
  const m = getMatch(matchId);
  if (asGk) {
    if (m.gk === num) { m.gk = null; if (!m.players.includes(num)) m.players.push(num); }
    else { m.players = m.players.filter(n => n !== num); m.gk = num; }
  } else {
    if (m.gk === num) { m.gk = null; }
    else if (m.players.includes(num)) { m.players = m.players.filter(n => n !== num); delete m.scorers[num]; }
    else { m.players.push(num); }
  }
  renderMatchPlayers(matchId);
}

function updateGkSelect(matchId) {
  const m = getMatch(matchId);
  const sel = document.getElementById(`gk-${matchId}`);
  if (!sel) return;
  const sorted = [...roster].sort((a,b) => a.num - b.num);
  sel.innerHTML = '<option value="">é¸æŠ</option>' +
    sorted.map(r => `<option value="${r.num}" ${r.num===m.gk?'selected':''}>${r.name}(${r.num})</option>`).join('');
}

function setGk(matchId, val) {
  const m = getMatch(matchId);
  if (m.gk && !m.players.includes(m.gk)) m.players.push(m.gk);
  const num = parseInt(val);
  if (num) { m.gk = num; m.players = m.players.filter(n => n !== num); }
  else { m.gk = null; }
  renderMatchPlayers(matchId);
}

// ========== Score ==========
function updateScore(matchId) {
  const m = getMatch(matchId);
  m.scoreUs = parseInt(document.getElementById(`score-us-${matchId}`).value) || 0;
  m.scoreOpponent = parseInt(document.getElementById(`score-opp-${matchId}`).value) || 0;
  const el = document.getElementById(`result-${matchId}`);
  if (!el) return;
  el.className = 'result-badge';
  if (m.scoreUs > m.scoreOpponent) { el.classList.add('win'); el.textContent = 'â—‹'; }
  else if (m.scoreUs === m.scoreOpponent) { el.classList.add('draw'); el.textContent = 'â–³'; }
  else { el.classList.add('lose'); el.textContent = 'Ã—'; }
}

// ========== Substitution ==========
function toggleSub(matchId) {
  const m = getMatch(matchId);
  m.showSub = !m.showSub;
  document.getElementById(`sub-${matchId}`).style.display = m.showSub ? 'block' : 'none';
  document.getElementById(`sub-toggle-${matchId}`).textContent = m.showSub ? 'ï¼ äº¤ä»£ã‚’é–‰ã˜ã‚‹' : 'ï¼‹ äº¤ä»£ã‚’å…¥åŠ›';
  if (m.showSub) updateSubDropdowns(matchId);
}

function setSubMode(matchId, mode) {
  const m = getMatch(matchId);
  m.subMode = mode;
  document.getElementById(`match-${matchId}`).querySelectorAll('.sub-mode-tab')
    .forEach(t => t.classList.toggle('active', t.dataset.mode === mode));
  document.getElementById(`sub-individual-${matchId}`).style.display = mode === 'individual' ? 'block' : 'none';
  document.getElementById(`sub-fullswap-${matchId}`).style.display = mode === 'fullswap' ? 'block' : 'none';
  if (mode === 'fullswap') renderSwapPlayers(matchId);
  renderScorers(matchId);
}

function addSubRow(matchId) {
  getMatch(matchId).subs.push({out: null, in: null});
  renderSubRows(matchId);
}

function removeSubRow(matchId, idx) {
  getMatch(matchId).subs.splice(idx, 1);
  renderSubRows(matchId);
  renderScorers(matchId);
}

function renderSubRows(matchId) {
  const m = getMatch(matchId);
  const container = document.getElementById(`sub-rows-${matchId}`);
  const onField = [...m.players, ...(m.gk ? [m.gk] : [])].sort((a,b) => a - b);

  container.innerHTML = m.subs.map((sub, idx) => {
    const outUsed = m.subs.filter((s,i) => i!==idx && s.out!==null).map(s => s.out);
    let outOpts = onField.filter(n => !outUsed.includes(n));
    if (sub.out !== null && !outOpts.includes(sub.out)) outOpts = [...outOpts, sub.out].sort((a,b)=>a-b);

    const inUsed = m.subs.filter((s,i) => i!==idx && s.in!==null).map(s => s.in);
    let inOpts = roster.filter(r => !onField.includes(r.num)).map(r => r.num).filter(n => !inUsed.includes(n));
    if (sub.in !== null && !inOpts.includes(sub.in)) inOpts = [...inOpts, sub.in].sort((a,b)=>a-b);
    inOpts.sort((a,b) => a - b);

    return `<div class="sub-row">
      <select onchange="setSubOut(${matchId},${idx},this.value)">
        <option value="">OUT</option>
        ${outOpts.map(n => `<option value="${n}" ${sub.out===n?'selected':''}>${getLabel(n)}</option>`).join('')}
      </select>
      <span class="sub-arrow">â†’</span>
      <select onchange="setSubIn(${matchId},${idx},this.value)">
        <option value="">IN</option>
        ${inOpts.map(n => `<option value="${n}" ${sub.in===n?'selected':''}>${getLabel(n)}</option>`).join('')}
      </select>
      <button class="sub-remove" onclick="removeSubRow(${matchId},${idx})">Ã—</button>
    </div>`;
  }).join('');

  const gkArea = document.getElementById(`sub-gk-area-${matchId}`);
  const valid = m.subs.filter(s => s.out!==null && s.in!==null);
  if (valid.length > 0) {
    gkArea.style.display = 'flex';
    const outs = new Set(valid.map(s => s.out));
    const ins = new Set(valid.map(s => s.in));
    const after = [...onField.filter(n => !outs.has(n)), ...ins].sort((a,b) => a-b);
    document.getElementById(`sub-gk-change-${matchId}`).innerHTML =
      '<option value="">å¤‰æ›´ãªã—</option>' +
      after.map(n => `<option value="${n}" ${m.subGkChange===n?'selected':''}>${getLabel(n)}</option>`).join('');
  } else { gkArea.style.display = 'none'; }
}

function setSubOut(mid, idx, v) { getMatch(mid).subs[idx].out = v ? parseInt(v) : null; renderSubRows(mid); renderScorers(mid); }
function setSubIn(mid, idx, v) { getMatch(mid).subs[idx].in = v ? parseInt(v) : null; renderSubRows(mid); renderScorers(mid); }
function setSubGkChange(mid, v) { getMatch(mid).subGkChange = v ? parseInt(v) : null; }
function updateSubDropdowns(mid) { const m=getMatch(mid); if(m.showSub && m.subMode==='individual') renderSubRows(mid); }

// Full swap
function renderSwapPlayers(matchId) {
  const m = getMatch(matchId);
  const grid = document.getElementById(`swap-players-${matchId}`);
  if (!grid) return;
  const sorted = [...roster].sort((a,b) => a.num - b.num);
  grid.innerHTML = sorted.map(r => {
    const isGk = m.swapGk === r.num;
    const isSel = m.swapPlayers.includes(r.num);
    let cls = 'player-chip';
    if (isGk) cls += ' gk';
    else if (isSel) cls += ' selected';
    const label = isGk ? `<span class="pname">GK ${r.name}</span><span class="pnum">${r.num}</span>`
                       : `<span class="pname">${r.name}</span><span class="pnum">${r.num}</span>`;
    return `<div class="${cls}"
      onclick="toggleSwapPlayer(${matchId},${r.num},false)"
      oncontextmenu="event.preventDefault();toggleSwapPlayer(${matchId},${r.num},true)"
      ontouchstart="lpStart(event,${matchId},${r.num},'sw')"
      ontouchend="lpEnd(event)" ontouchmove="lpEnd(event)"
    >${label}</div>`;
  }).join('');
  const total = m.swapPlayers.length + (m.swapGk ? 1 : 0);
  const c = document.getElementById(`swapcount-${matchId}`);
  if (c) c.textContent = `${total}äºº`;
  const sel = document.getElementById(`swap-gk-${matchId}`);
  if (sel) {
    sel.innerHTML = '<option value="">é¸æŠ</option>' +
      sorted.map(r => `<option value="${r.num}" ${r.num===m.swapGk?'selected':''}>${r.name}(${r.num})</option>`).join('');
  }
}

function toggleSwapPlayer(matchId, num, asGk) {
  if (lpFired && !asGk) return;
  const m = getMatch(matchId);
  if (asGk) {
    if (m.swapGk===num) { m.swapGk=null; if(!m.swapPlayers.includes(num)) m.swapPlayers.push(num); }
    else { m.swapPlayers=m.swapPlayers.filter(n=>n!==num); m.swapGk=num; }
  } else {
    if (m.swapGk===num) m.swapGk=null;
    else if (m.swapPlayers.includes(num)) m.swapPlayers=m.swapPlayers.filter(n=>n!==num);
    else m.swapPlayers.push(num);
  }
  renderSwapPlayers(matchId);
  renderScorers(matchId);
}

function setSwapGk(matchId, val) {
  const m = getMatch(matchId);
  if (m.swapGk && !m.swapPlayers.includes(m.swapGk)) m.swapPlayers.push(m.swapGk);
  const num = parseInt(val);
  if (num) { m.swapGk=num; m.swapPlayers=m.swapPlayers.filter(n=>n!==num); }
  else m.swapGk=null;
  renderSwapPlayers(matchId);
  renderScorers(matchId);
}

// ========== Scorers ==========
function renderScorers(matchId) {
  const m = getMatch(matchId);
  const grid = document.getElementById(`scorers-${matchId}`);
  if (!grid) return;

  let all = [...m.players];
  if (m.gk) all.push(m.gk);
  if (m.showSub) {
    if (m.subMode === 'individual') {
      m.subs.forEach(s => { if (s.in && !all.includes(s.in)) all.push(s.in); });
    } else {
      m.swapPlayers.forEach(n => { if (!all.includes(n)) all.push(n); });
      if (m.swapGk && !all.includes(m.swapGk)) all.push(m.swapGk);
    }
  }
  all = [...new Set(all)].sort((a,b) => a - b);

  if (all.length === 0) {
    grid.innerHTML = '<span style="font-size:12px;color:#999;">å…ˆã«å‡ºå ´é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</span>';
    return;
  }
  Object.keys(m.scorers).forEach(k => { if (!all.includes(parseInt(k))) delete m.scorers[k]; });

  grid.innerHTML = all.map(num => {
    const count = m.scorers[num] || 0;
    const cls = count > 0 ? 'scorer-chip selected' : 'scorer-chip';
    return `<div class="${cls}"
      onclick="toggleScorer(${matchId},${num})"
      ontouchstart="lpStart(event,${matchId},${num},'sc')"
      ontouchend="lpEnd(event)" ontouchmove="lpEnd(event)"
    ><span>${getName(num)}</span>${count > 1 ? `<span class="count">Ã—${count}</span>` : ''}</div>`;
  }).join('');
}

function toggleScorer(mid, num) {
  if (lpFired) return;
  const m = getMatch(mid);
  m.scorers[num] = (m.scorers[num]||0) + 1;
  renderScorers(mid);
}
function resetScorer(mid, num) { delete getMatch(mid).scorers[num]; renderScorers(mid); }

// ========== Generate ==========
function generateOutput() {
  const date = document.getElementById('match-date').value;
  const type = document.querySelector('#match-type-options .chip.active')?.dataset.val || 'TM';
  const tournament = document.getElementById('tournament-name').value.trim();
  const venue = document.getElementById('venue').value.trim();

  const d = new Date(date + 'T00:00:00');
  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const dateStr = `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}(${days[d.getDay()]})`;

  const preset = document.querySelector('#format-presets .format-chip.active');
  let fmtStr;
  if (preset && preset.dataset.min) {
    fmtStr = preset.dataset.per==='2' ? `${preset.dataset.min}åˆ†ãƒãƒ¼ãƒ•` : `${preset.dataset.min}åˆ†Ã—${preset.dataset.per}`;
  } else { fmtStr = `${formatMinutes}åˆ†Ã—${formatPeriods}`; }

  // Check if all opponents are the same
  const allOpps = matches.map(m => m.opponent).filter(Boolean);
  const uniqueOpps = [...new Set(allOpps)];
  const sameOpponent = uniqueOpps.length === 1;

  let lines = [];
  let header = `${dateStr} ${type}`;
  if (tournament) header += ` ${tournament}`;
  if (sameOpponent) header += ` vs${uniqueOpps[0]}`;
  lines.push(header);
  lines.push(`@${venue}`);
  lines.push(`è©¦åˆå½¢å¼${fmtStr}`);
  lines.push('');

  matches.forEach((m, i) => {
    const starters = [...m.players].sort((a,b) => a-b);
    let pStr = starters.join('.');
    if (m.gk !== null) { if (pStr) pStr += '.'; pStr += `GK${m.gk}`; }

    if (m.showSub) {
      if (m.subMode === 'individual') {
        const valid = m.subs.filter(s => s.out!==null && s.in!==null);
        if (valid.length > 0) {
          let subStr = valid.map(s => s.in).sort((a,b)=>a-b).join('.');
          if (m.subGkChange) subStr += `.GK${m.subGkChange}`;
          pStr += `â†’${subStr}`;
        }
      } else {
        if (m.swapPlayers.length > 0 || m.swapGk !== null) {
          const sf = [...m.swapPlayers].sort((a,b)=>a-b);
          let ss = sf.join('.');
          if (m.swapGk !== null) { if(ss) ss+='.'; ss+=`GK${m.swapGk}`; }
          pStr += `\nã€€ã€€ã€€ã€€â†’${ss}`;
        }
      }
    }

    const us = m.scoreUs, opp = m.scoreOpponent;
    let result = us > opp ? 'â—‹' : us === opp ? 'â–³' : 'Ã—';

    let scorerParts = [];
    Object.entries(m.scorers).forEach(([p, c]) => { for(let i=0;i<c;i++) scorerParts.push(p); });
    const scorerStr = scorerParts.length > 0 ? scorerParts.join(',') : 'ãªã—';

    let matchLine = `(${i+1}è©¦åˆç›®)`;
    if (!sameOpponent && m.opponent) matchLine += ` vs${m.opponent}`;
    lines.push(matchLine);
    lines.push(`å‡ºå ´é¸æ‰‹ï¼š${pStr}`);
    lines.push(`ã‚¹ã‚³ã‚¢ï¼š${us}-${opp} ${result}`);
    lines.push(`å¾—ç‚¹è€…ï¼š${scorerStr}`);
    if (m.memo) lines.push(`ãƒ¡ãƒ¢ï¼š${m.memo}`);
    lines.push('');
  });

  const output = lines.join('\n').trimEnd();
  document.getElementById('output-area').textContent = output;
  document.getElementById('output-area').style.display = 'block';
  document.getElementById('copy-btn').style.display = 'block';
  document.getElementById('output-area').scrollIntoView({behavior:'smooth',block:'start'});
}

function copyOutput() {
  const text = document.getElementById('output-area').textContent;
  navigator.clipboard.writeText(text).then(()=>showToast()).catch(()=>{
    const ta=document.createElement('textarea'); ta.value=text;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    showToast();
  });
}
function showToast() {
  const t=document.createElement('div'); t.className='copy-success';
  t.textContent='ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'; document.body.appendChild(t);
  setTimeout(()=>t.remove(),1600);
}

init();
</script>
</body>
</html>
