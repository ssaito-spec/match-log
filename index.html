<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è©¦åˆãƒ­ã‚°å…¥åŠ›</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', sans-serif;
    background: #f0f2f5;
    color: #1a1a1a;
    padding: 12px;
    max-width: 480px;
    margin: 0 auto;
  }
  h1 {
    font-size: 18px;
    text-align: center;
    padding: 12px 0;
    color: #333;
  }

  .card {
    background: #fff;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  .card-title {
    font-size: 14px;
    font-weight: 700;
    color: #555;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #777;
    margin-bottom: 4px;
    margin-top: 10px;
  }
  label:first-child { margin-top: 0; }

  input[type="text"], input[type="date"], input[type="number"], select {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    background: #fafafa;
    transition: border-color 0.2s;
    -webkit-appearance: none;
  }
  input:focus, select:focus {
    outline: none;
    border-color: #4a90d9;
    background: #fff;
  }

  /* Chips (shared) */
  .chip-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
  }
  .chip {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px 14px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    background: #fafafa;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .chip.active {
    background: #4a90d9;
    color: #fff;
    border-color: #4a90d9;
  }

  /* Player chips */
  .player-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
  }
  .player-chip {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 38px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    user-select: none;
    background: #fafafa;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .player-chip.selected {
    background: #4a90d9;
    color: #fff;
    border-color: #4a90d9;
  }
  .player-chip.gk {
    background: #f59e0b;
    color: #fff;
    border-color: #f59e0b;
  }

  .player-count {
    display: inline-block;
    background: #4a90d9;
    color: #fff;
    font-size: 12px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 6px;
  }

  .gk-row {
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .gk-row label { margin: 0; white-space: nowrap; }
  .gk-row select { flex: 1; }

  /* Score */
  .score-row {
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
    margin-top: 6px;
  }
  .score-input {
    width: 60px !important;
    text-align: center;
    font-size: 24px !important;
    font-weight: 700;
    padding: 8px !important;
  }
  .score-divider {
    font-size: 24px;
    font-weight: 700;
    color: #999;
  }
  .result-badge {
    font-size: 20px;
    font-weight: 900;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .result-badge.win { background: #e8f5e9; color: #2e7d32; }
  .result-badge.draw { background: #fff8e1; color: #f57f17; }
  .result-badge.lose { background: #fce4ec; color: #c62828; }
  .result-badge.none { background: #f5f5f5; color: #bbb; }

  /* Scorer */
  .scorer-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
  }
  .scorer-chip {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    height: 34px;
    padding: 0 10px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    background: #fafafa;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
    position: relative;
  }
  .scorer-chip.selected {
    background: #e74c3c;
    color: #fff;
    border-color: #e74c3c;
  }
  .scorer-chip .count {
    margin-left: 3px;
    font-size: 11px;
    opacity: 0.9;
  }
  .hint {
    font-size: 11px;
    color: #aaa;
    margin-top: 4px;
    line-height: 1.4;
  }

  /* Substitution */
  .sub-section {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px dashed #e0e0e0;
  }
  .sub-toggle {
    font-size: 13px;
    color: #4a90d9;
    cursor: pointer;
    font-weight: 600;
    -webkit-tap-highlight-color: transparent;
  }
  .sub-content { margin-top: 8px; }
  .sub-mode-tabs {
    display: flex;
    margin-bottom: 10px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #4a90d9;
  }
  .sub-mode-tab {
    flex: 1;
    padding: 8px;
    text-align: center;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    background: #fff;
    color: #4a90d9;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .sub-mode-tab.active {
    background: #4a90d9;
    color: #fff;
  }
  .sub-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 8px;
    background: #f8f9fa;
    padding: 10px 8px;
    border-radius: 8px;
  }
  .sub-row select {
    flex: 1;
    padding: 8px;
    font-size: 15px;
    font-weight: 700;
  }
  .sub-arrow {
    font-size: 18px;
    font-weight: 700;
    color: #4a90d9;
    flex-shrink: 0;
  }
  .sub-remove {
    width: 28px;
    height: 28px;
    border: none;
    background: #fee;
    color: #e74c3c;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .sub-gk-change {
    margin-top: 8px;
    padding: 8px;
    background: #fff8e1;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .sub-gk-change label { margin: 0; font-size: 12px; color: #f59e0b; font-weight: 700; white-space: nowrap; }
  .sub-gk-change select { flex: 1; font-size: 14px; padding: 8px; }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-primary {
    background: #4a90d9;
    color: #fff;
    width: 100%;
    padding: 14px;
    font-size: 16px;
  }
  .btn-primary:active { background: #3a7bc8; }
  .btn-secondary {
    background: #e8ecf1;
    color: #555;
    width: 100%;
    padding: 12px;
  }
  .btn-secondary:active { background: #d8dce1; }
  .btn-danger {
    background: #fee;
    color: #e74c3c;
    font-size: 12px;
    padding: 6px 12px;
  }
  .btn-add-sub {
    background: #e8f4fd;
    color: #4a90d9;
    font-size: 13px;
    padding: 8px 14px;
    width: 100%;
  }

  .match-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .match-number {
    font-size: 16px;
    font-weight: 700;
    color: #4a90d9;
  }

  /* Venue row */
  .venue-row {
    display: flex;
    gap: 6px;
    align-items: stretch;
  }
  .venue-row input { flex: 1; }
  .map-btn {
    flex-shrink: 0;
    width: 44px;
    border: 1.5px solid #ddd;
    border-radius: 8px;
    background: #fafafa;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .map-btn:active { background: #e8ecf1; }

  /* Format presets */
  .format-presets {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
  }
  .format-chip {
    padding: 7px 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    background: #fafafa;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .format-chip.active {
    background: #4a90d9;
    color: #fff;
    border-color: #4a90d9;
  }
  .format-custom {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 8px;
  }
  .format-custom input {
    width: 55px !important;
    text-align: center;
  }
  .format-custom span {
    font-size: 14px;
    font-weight: 600;
    color: #555;
  }

  /* Output */
  #output-area {
    background: #1a1a2e;
    color: #e0e0e0;
    border-radius: 12px;
    padding: 16px;
    font-family: monospace;
    font-size: 13px;
    white-space: pre-wrap;
    word-break: break-all;
    line-height: 1.6;
    margin-top: 12px;
    display: none;
  }
  .copy-success {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 16px 32px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    z-index: 100;
    animation: fadeOut 1.5s ease forwards;
  }
  @keyframes fadeOut {
    0%, 60% { opacity: 1; }
    100% { opacity: 0; }
  }

  .roster-input-row {
    display: flex;
    gap: 6px;
    margin-top: 8px;
  }
  .roster-input-row input { flex: 1; }
  .roster-input-row .btn { flex-shrink: 0; width: auto; }
  .roster-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 8px;
  }
  .roster-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: #e8ecf1;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 13px;
    font-weight: 600;
  }
  .roster-tag .remove {
    cursor: pointer;
    color: #999;
    font-size: 16px;
    line-height: 1;
  }
</style>
</head>
<body>

<h1>âš½ è©¦åˆãƒ­ã‚°å…¥åŠ›</h1>

<!-- Basic Info -->
<div class="card">
  <div class="card-title"><span>ğŸ“‹</span> åŸºæœ¬æƒ…å ±</div>
  <label>æ—¥ä»˜</label>
  <input type="date" id="match-date">

  <label>è©¦åˆç¨®åˆ¥</label>
  <div class="chip-grid" id="match-type-options">
    <div class="chip active" data-val="TM">TM</div>
    <div class="chip" data-val="å…¬å¼æˆ¦">å…¬å¼æˆ¦</div>
    <div class="chip" data-val="ã‚«ãƒƒãƒ—æˆ¦">ã‚«ãƒƒãƒ—æˆ¦</div>
    <div class="chip" data-val="ãƒªãƒ¼ã‚°æˆ¦">ãƒªãƒ¼ã‚°æˆ¦</div>
  </div>

  <label>å¤§ä¼šåï¼ˆä»»æ„ï¼‰</label>
  <input type="text" id="tournament-name" placeholder="ä¾‹: ANTLERS CUP 2025">

  <label>å¯¾æˆ¦ç›¸æ‰‹</label>
  <input type="text" id="opponent" placeholder="ä¾‹: ã‚¨ã‚¯ã‚»ãƒ¬ãƒ³ãƒˆãƒ•ã‚£ãƒ¼ãƒˆ">

  <label>ä¼šå ´</label>
  <div class="venue-row">
    <input type="text" id="venue" placeholder="ä¾‹: SFAãƒ•ãƒƒãƒˆãƒœãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼">
    <button class="map-btn" onclick="openMap()" title="Google Mapã§é–‹ã">ğŸ“</button>
  </div>

  <label>è©¦åˆå½¢å¼</label>
  <div class="format-presets" id="format-presets">
    <div class="format-chip active" data-min="15" data-per="1" data-label="15åˆ†Ã—1æœ¬">15åˆ†Ã—1æœ¬</div>
    <div class="format-chip" data-min="15" data-per="2" data-label="15åˆ†ãƒãƒ¼ãƒ•">15åˆ†ãƒãƒ¼ãƒ•</div>
    <div class="format-chip" data-min="20" data-per="2" data-label="20åˆ†ãƒãƒ¼ãƒ•">20åˆ†ãƒãƒ¼ãƒ•</div>
    <div class="format-chip" data-min="" data-per="" data-label="ã‚«ã‚¹ã‚¿ãƒ ">ã‚«ã‚¹ã‚¿ãƒ </div>
  </div>
  <div class="format-custom" id="format-custom" style="display:none;">
    <input type="number" id="match-minutes" value="15" min="1" max="90">
    <span>åˆ† Ã—</span>
    <input type="number" id="match-halves" value="1" min="1" max="4">
    <span>æœ¬</span>
  </div>
</div>

<!-- Roster -->
<div class="card">
  <div class="card-title"><span>ğŸ‘•</span> ç™»éŒ²ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆèƒŒç•ªå·ï¼‰</div>
  <p style="font-size:12px;color:#999;margin-bottom:6px;">ã“ã“ã«ç™»éŒ²ã—ãŸç•ªå·ãŒå„è©¦åˆã®é¸æ‰‹é¸æŠã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
  <div class="roster-tags" id="roster-tags"></div>
  <div class="roster-input-row">
    <input type="number" id="roster-new" placeholder="èƒŒç•ªå·" min="1" max="99">
    <button class="btn btn-secondary" onclick="addRosterNumber()" style="padding:8px 16px;">è¿½åŠ </button>
  </div>
</div>

<!-- Matches -->
<div id="matches-container"></div>

<button class="btn btn-secondary" onclick="addMatch()" style="margin-bottom:12px;">
  ï¼‹ è©¦åˆã‚’è¿½åŠ 
</button>

<button class="btn btn-primary" onclick="generateOutput()">
  ğŸ“ ãƒ­ã‚°ã‚’ç”Ÿæˆ
</button>

<pre id="output-area"></pre>
<button class="btn btn-primary" id="copy-btn" onclick="copyOutput()" style="display:none;margin-top:8px;background:#27ae60;">
  ğŸ“‹ ã‚³ãƒ”ãƒ¼
</button>

<div style="height:40px;"></div>

<script>
// ========== State ==========
let roster = [2,3,4,8,9,10,11,14,16,18,19,20,22,24,28,65];
let matches = [];
let matchCounter = 0;
let formatMinutes = 15;
let formatPeriods = 1;
let formatLabel = '15åˆ†Ã—1æœ¬';

// ========== Init ==========
function init() {
  document.getElementById('match-date').value = new Date().toISOString().slice(0,10);

  const saved = localStorage.getItem('soccer-roster');
  if (saved) roster = JSON.parse(saved);
  renderRoster();

  // Match type chips
  document.querySelectorAll('#match-type-options .chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('#match-type-options .chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
    });
  });

  // Format presets
  document.querySelectorAll('#format-presets .format-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('#format-presets .format-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      const min = chip.dataset.min;
      const per = chip.dataset.per;
      if (min && per) {
        formatMinutes = parseInt(min);
        formatPeriods = parseInt(per);
        formatLabel = chip.dataset.label;
        document.getElementById('format-custom').style.display = 'none';
      } else {
        document.getElementById('format-custom').style.display = 'flex';
        formatMinutes = parseInt(document.getElementById('match-minutes').value) || 15;
        formatPeriods = parseInt(document.getElementById('match-halves').value) || 1;
        formatLabel = '';
      }
    });
  });

  document.getElementById('match-minutes').addEventListener('input', function() {
    formatMinutes = parseInt(this.value) || 15;
  });
  document.getElementById('match-halves').addEventListener('input', function() {
    formatPeriods = parseInt(this.value) || 1;
  });

  document.getElementById('roster-new').addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); addRosterNumber(); }
  });

  addMatch();
}

// ========== Google Maps ==========
function openMap() {
  const venue = document.getElementById('venue').value.trim();
  if (!venue) { alert('ä¼šå ´åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(venue)}`, '_blank');
}

// ========== Roster ==========
function renderRoster() {
  roster.sort((a,b) => a - b);
  document.getElementById('roster-tags').innerHTML = roster.map(n =>
    `<span class="roster-tag">${n}<span class="remove" onclick="removeRosterNumber(${n})">Ã—</span></span>`
  ).join('');
  localStorage.setItem('soccer-roster', JSON.stringify(roster));
  matches.forEach(m => renderMatchPlayers(m.id));
}

function addRosterNumber() {
  const input = document.getElementById('roster-new');
  const num = parseInt(input.value);
  if (!num || num < 1 || num > 99) return;
  if (!roster.includes(num)) { roster.push(num); renderRoster(); }
  input.value = '';
  input.focus();
}

function removeRosterNumber(num) {
  roster = roster.filter(n => n !== num);
  renderRoster();
}

// ========== Matches ==========
function addMatch() {
  matchCounter++;
  const match = {
    id: matchCounter,
    players: [],
    gk: null,
    scoreUs: 0,
    scoreOpponent: 0,
    scorers: {},
    showSub: false,
    subMode: 'individual',
    subs: [],
    subGkChange: null,
    swapPlayers: [],
    swapGk: null,
    memo: ''
  };
  matches.push(match);
  renderMatch(match);
}

function removeMatch(id) {
  matches = matches.filter(m => m.id !== id);
  document.getElementById(`match-${id}`).remove();
  renumberMatches();
}

function renumberMatches() {
  document.querySelectorAll('.match-card').forEach((card, i) => {
    card.querySelector('.match-number').textContent = `ç¬¬${i+1}è©¦åˆ`;
  });
}

function getMatch(id) { return matches.find(m => m.id === id); }

function renderMatch(match) {
  const div = document.createElement('div');
  div.className = 'card match-card';
  div.id = `match-${match.id}`;
  const idx = matches.indexOf(match) + 1;
  const mid = match.id;

  div.innerHTML = `
    <div class="match-header">
      <span class="match-number">ç¬¬${idx}è©¦åˆ</span>
      <button class="btn btn-danger" onclick="removeMatch(${mid})">å‰Šé™¤</button>
    </div>

    <label>
      å‡ºå ´é¸æ‰‹ï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠ / é•·æŠ¼ã—ã§GKï¼‰
      <span class="player-count" id="pcount-${mid}">0äºº</span>
    </label>
    <div class="player-grid" id="players-${mid}"></div>
    <div class="gk-row">
      <label style="font-size:13px;color:#f59e0b;font-weight:700;">GK:</label>
      <select id="gk-${mid}" onchange="setGk(${mid}, this.value)">
        <option value="">é¸æŠ</option>
      </select>
    </div>

    <div class="sub-section">
      <span class="sub-toggle" id="sub-toggle-${mid}" onclick="toggleSub(${mid})">ï¼‹ äº¤ä»£ã‚’å…¥åŠ›</span>
      <div class="sub-content" id="sub-${mid}" style="display:none;">
        <div class="sub-mode-tabs">
          <div class="sub-mode-tab active" data-mode="individual" onclick="setSubMode(${mid},'individual')">å€‹åˆ¥äº¤ä»£</div>
          <div class="sub-mode-tab" data-mode="fullswap" onclick="setSubMode(${mid},'fullswap')">ç·å…¥æ›¿ãˆ</div>
        </div>
        <div id="sub-individual-${mid}">
          <div id="sub-rows-${mid}"></div>
          <button class="btn btn-add-sub" onclick="addSubRow(${mid})">ï¼‹ äº¤ä»£ã‚’è¿½åŠ </button>
          <div class="sub-gk-change" id="sub-gk-area-${mid}" style="display:none;">
            <label>GKå¤‰æ›´â†’</label>
            <select id="sub-gk-change-${mid}" onchange="setSubGkChange(${mid}, this.value)">
              <option value="">å¤‰æ›´ãªã—</option>
            </select>
          </div>
        </div>
        <div id="sub-fullswap-${mid}" style="display:none;">
          <label>äº¤ä»£å¾Œã®å…¨ãƒ¡ãƒ³ãƒãƒ¼
            <span class="player-count" id="swapcount-${mid}">0äºº</span>
          </label>
          <div class="player-grid" id="swap-players-${mid}"></div>
          <div class="gk-row">
            <label style="font-size:13px;color:#f59e0b;font-weight:700;">GK:</label>
            <select id="swap-gk-${mid}" onchange="setSwapGk(${mid}, this.value)">
              <option value="">é¸æŠ</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <label>ã‚¹ã‚³ã‚¢ï¼ˆè‡ªãƒãƒ¼ãƒ  - ç›¸æ‰‹ï¼‰</label>
    <div class="score-row">
      <input type="number" class="score-input" id="score-us-${mid}" value="0" min="0" max="99"
        oninput="updateScore(${mid})">
      <span class="score-divider">-</span>
      <input type="number" class="score-input" id="score-opp-${mid}" value="0" min="0" max="99"
        oninput="updateScore(${mid})">
      <div class="result-badge none" id="result-${mid}">-</div>
    </div>

    <label>å¾—ç‚¹è€…ï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠã€è¤‡æ•°å›ã‚¿ãƒƒãƒ—ã§è¤‡æ•°å¾—ç‚¹ï¼‰</label>
    <div class="hint">ã‚¿ãƒƒãƒ—: +1ç‚¹ ï¼ é•·æŠ¼ã—: ãƒªã‚»ãƒƒãƒˆ</div>
    <div class="scorer-grid" id="scorers-${mid}">
      <span style="font-size:12px;color:#999;">å…ˆã«å‡ºå ´é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
    </div>

    <div style="margin-top:8px;">
      <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="memo-${mid}" placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°"
        oninput="getMatch(${mid}).memo=this.value">
    </div>
  `;

  document.getElementById('matches-container').appendChild(div);
  renderMatchPlayers(mid);
}

// ========== Player selection ==========
function renderMatchPlayers(matchId) {
  const m = getMatch(matchId);
  if (!m) return;
  const grid = document.getElementById(`players-${matchId}`);
  if (!grid) return;

  const sorted = [...roster].sort((a,b) => a - b);
  grid.innerHTML = sorted.map(num => {
    const isGk = m.gk === num;
    const isSel = m.players.includes(num);
    let cls = 'player-chip';
    if (isGk) cls += ' gk';
    else if (isSel) cls += ' selected';
    return `<div class="${cls}"
      onclick="togglePlayer(${matchId},${num},false)"
      oncontextmenu="event.preventDefault();togglePlayer(${matchId},${num},true)"
      ontouchstart="lpStart(event,${matchId},${num},'fp')"
      ontouchend="lpEnd(event)" ontouchmove="lpEnd(event)"
    >${isGk ? 'GK'+num : num}</div>`;
  }).join('');

  // Player count
  const total = m.players.length + (m.gk ? 1 : 0);
  const countEl = document.getElementById(`pcount-${matchId}`);
  if (countEl) countEl.textContent = `${total}äºº`;

  updateGkSelect(matchId);
  renderScorers(matchId);
  updateSubDropdowns(matchId);
  renderSwapPlayers(matchId);
}

// Long press
let lpTimer = null, lpFired = false;
function lpStart(e, mid, num, type) {
  lpFired = false;
  lpTimer = setTimeout(() => {
    lpFired = true;
    if (type === 'fp') togglePlayer(mid, num, true);
    else if (type === 'sw') toggleSwapPlayer(mid, num, true);
    else if (type === 'sc') resetScorer(mid, num);
  }, 500);
}
function lpEnd() { if (lpTimer) { clearTimeout(lpTimer); lpTimer = null; } }

function togglePlayer(matchId, num, asGk) {
  if (lpFired && !asGk) return;
  const m = getMatch(matchId);
  if (asGk) {
    if (m.gk === num) { m.gk = null; if (!m.players.includes(num)) m.players.push(num); }
    else { m.players = m.players.filter(n => n !== num); m.gk = num; }
  } else {
    if (m.gk === num) { m.gk = null; }
    else if (m.players.includes(num)) { m.players = m.players.filter(n => n !== num); delete m.scorers[num]; }
    else { m.players.push(num); }
  }
  renderMatchPlayers(matchId);
}

function updateGkSelect(matchId) {
  const m = getMatch(matchId);
  const sel = document.getElementById(`gk-${matchId}`);
  if (!sel) return;
  const sorted = [...roster].sort((a,b) => a - b);
  sel.innerHTML = '<option value="">é¸æŠ</option>' +
    sorted.map(n => `<option value="${n}" ${n===m.gk?'selected':''}>${n}</option>`).join('');
}

function setGk(matchId, val) {
  const m = getMatch(matchId);
  if (m.gk && !m.players.includes(m.gk)) m.players.push(m.gk);
  const num = parseInt(val);
  if (num) { m.gk = num; m.players = m.players.filter(n => n !== num); }
  else { m.gk = null; }
  renderMatchPlayers(matchId);
}

// ========== Score & Result ==========
function updateScore(matchId) {
  const m = getMatch(matchId);
  m.scoreUs = parseInt(document.getElementById(`score-us-${matchId}`).value) || 0;
  m.scoreOpponent = parseInt(document.getElementById(`score-opp-${matchId}`).value) || 0;
  updateResultBadge(matchId);
}

function updateResultBadge(matchId) {
  const m = getMatch(matchId);
  const el = document.getElementById(`result-${matchId}`);
  if (!el) return;
  const us = m.scoreUs, opp = m.scoreOpponent;
  el.className = 'result-badge';
  if (us === 0 && opp === 0 && !document.getElementById(`score-us-${matchId}`).value &&
      !document.getElementById(`score-opp-${matchId}`).value) {
    el.classList.add('none'); el.textContent = '-';
  } else if (us > opp) {
    el.classList.add('win'); el.textContent = 'â—‹';
  } else if (us === opp) {
    el.classList.add('draw'); el.textContent = 'â–³';
  } else {
    el.classList.add('lose'); el.textContent = 'Ã—';
  }
}

// ========== Substitution ==========
function toggleSub(matchId) {
  const m = getMatch(matchId);
  m.showSub = !m.showSub;
  document.getElementById(`sub-${matchId}`).style.display = m.showSub ? 'block' : 'none';
  document.getElementById(`sub-toggle-${matchId}`).textContent = m.showSub ? 'ï¼ äº¤ä»£ã‚’é–‰ã˜ã‚‹' : 'ï¼‹ äº¤ä»£ã‚’å…¥åŠ›';
  if (m.showSub) updateSubDropdowns(matchId);
}

function setSubMode(matchId, mode) {
  const m = getMatch(matchId);
  m.subMode = mode;
  const card = document.getElementById(`match-${matchId}`);
  card.querySelectorAll('.sub-mode-tab').forEach(t => t.classList.toggle('active', t.dataset.mode === mode));
  document.getElementById(`sub-individual-${matchId}`).style.display = mode === 'individual' ? 'block' : 'none';
  document.getElementById(`sub-fullswap-${matchId}`).style.display = mode === 'fullswap' ? 'block' : 'none';
  if (mode === 'fullswap') renderSwapPlayers(matchId);
  renderScorers(matchId);
}

// --- Individual subs (fixed) ---
function addSubRow(matchId) {
  getMatch(matchId).subs.push({ out: null, in: null });
  renderSubRows(matchId);
}

function removeSubRow(matchId, idx) {
  getMatch(matchId).subs.splice(idx, 1);
  renderSubRows(matchId);
  renderScorers(matchId);
}

function renderSubRows(matchId) {
  const m = getMatch(matchId);
  const container = document.getElementById(`sub-rows-${matchId}`);

  // On-field: starters + GK
  const onField = [...m.players, ...(m.gk ? [m.gk] : [])].sort((a,b) => a - b);

  container.innerHTML = m.subs.map((sub, idx) => {
    // OUT: on-field players not used as OUT in OTHER rows
    const outUsedByOthers = m.subs
      .filter((s, i) => i !== idx && s.out !== null)
      .map(s => s.out);
    const outOptions = onField.filter(n => !outUsedByOthers.includes(n));

    // IN: bench players (roster minus on-field) not used as IN in OTHER rows
    const inUsedByOthers = m.subs
      .filter((s, i) => i !== idx && s.in !== null)
      .map(s => s.in);
    const bench = roster
      .filter(n => !onField.includes(n))
      .filter(n => !inUsedByOthers.includes(n));

    // Make sure current selection is always in the options
    const outOpts = sub.out !== null && !outOptions.includes(sub.out)
      ? [...outOptions, sub.out].sort((a,b) => a-b) : outOptions;
    const inOpts = sub.in !== null && !bench.includes(sub.in)
      ? [...bench, sub.in].sort((a,b) => a-b) : bench;

    return `<div class="sub-row">
      <select onchange="setSubOut(${matchId},${idx},this.value)">
        <option value="">OUT</option>
        ${outOpts.map(n => `<option value="${n}" ${sub.out===n?'selected':''}>${n}</option>`).join('')}
      </select>
      <span class="sub-arrow">â†’</span>
      <select onchange="setSubIn(${matchId},${idx},this.value)">
        <option value="">IN</option>
        ${inOpts.map(n => `<option value="${n}" ${sub.in===n?'selected':''}>${n}</option>`).join('')}
      </select>
      <button class="sub-remove" onclick="removeSubRow(${matchId},${idx})">Ã—</button>
    </div>`;
  }).join('');

  // GK change area
  const gkArea = document.getElementById(`sub-gk-area-${matchId}`);
  const validSubs = m.subs.filter(s => s.out !== null && s.in !== null);
  if (validSubs.length > 0) {
    gkArea.style.display = 'flex';
    const outsSet = new Set(validSubs.map(s => s.out));
    const insSet = new Set(validSubs.map(s => s.in));
    const afterField = [...onField.filter(n => !outsSet.has(n)), ...insSet].sort((a,b) => a - b);
    const gkSel = document.getElementById(`sub-gk-change-${matchId}`);
    gkSel.innerHTML = '<option value="">å¤‰æ›´ãªã—</option>' +
      afterField.map(n => `<option value="${n}" ${m.subGkChange===n?'selected':''}>${n}</option>`).join('');
  } else {
    gkArea.style.display = 'none';
  }
}

function setSubOut(matchId, idx, val) {
  getMatch(matchId).subs[idx].out = val ? parseInt(val) : null;
  renderSubRows(matchId);
  renderScorers(matchId);
}

function setSubIn(matchId, idx, val) {
  getMatch(matchId).subs[idx].in = val ? parseInt(val) : null;
  renderSubRows(matchId);
  renderScorers(matchId);
}

function setSubGkChange(matchId, val) {
  getMatch(matchId).subGkChange = val ? parseInt(val) : null;
}

function updateSubDropdowns(matchId) {
  const m = getMatch(matchId);
  if (m.showSub && m.subMode === 'individual') renderSubRows(matchId);
}

// --- Full swap ---
function renderSwapPlayers(matchId) {
  const m = getMatch(matchId);
  const grid = document.getElementById(`swap-players-${matchId}`);
  if (!grid) return;

  const sorted = [...roster].sort((a,b) => a - b);
  grid.innerHTML = sorted.map(num => {
    const isGk = m.swapGk === num;
    const isSel = m.swapPlayers.includes(num);
    let cls = 'player-chip';
    if (isGk) cls += ' gk';
    else if (isSel) cls += ' selected';
    return `<div class="${cls}"
      onclick="toggleSwapPlayer(${matchId},${num},false)"
      oncontextmenu="event.preventDefault();toggleSwapPlayer(${matchId},${num},true)"
      ontouchstart="lpStart(event,${matchId},${num},'sw')"
      ontouchend="lpEnd(event)" ontouchmove="lpEnd(event)"
    >${isGk ? 'GK'+num : num}</div>`;
  }).join('');

  const total = m.swapPlayers.length + (m.swapGk ? 1 : 0);
  const countEl = document.getElementById(`swapcount-${matchId}`);
  if (countEl) countEl.textContent = `${total}äºº`;

  const sel = document.getElementById(`swap-gk-${matchId}`);
  if (sel) {
    sel.innerHTML = '<option value="">é¸æŠ</option>' +
      sorted.map(n => `<option value="${n}" ${n===m.swapGk?'selected':''}>${n}</option>`).join('');
  }
}

function toggleSwapPlayer(matchId, num, asGk) {
  if (lpFired && !asGk) return;
  const m = getMatch(matchId);
  if (asGk) {
    if (m.swapGk === num) { m.swapGk = null; if (!m.swapPlayers.includes(num)) m.swapPlayers.push(num); }
    else { m.swapPlayers = m.swapPlayers.filter(n => n !== num); m.swapGk = num; }
  } else {
    if (m.swapGk === num) { m.swapGk = null; }
    else if (m.swapPlayers.includes(num)) { m.swapPlayers = m.swapPlayers.filter(n => n !== num); }
    else { m.swapPlayers.push(num); }
  }
  renderSwapPlayers(matchId);
  renderScorers(matchId);
}

function setSwapGk(matchId, val) {
  const m = getMatch(matchId);
  if (m.swapGk && !m.swapPlayers.includes(m.swapGk)) m.swapPlayers.push(m.swapGk);
  const num = parseInt(val);
  if (num) { m.swapGk = num; m.swapPlayers = m.swapPlayers.filter(n => n !== num); }
  else { m.swapGk = null; }
  renderSwapPlayers(matchId);
  renderScorers(matchId);
}

// ========== Scorers ==========
function renderScorers(matchId) {
  const m = getMatch(matchId);
  const grid = document.getElementById(`scorers-${matchId}`);
  if (!grid) return;

  let allPlayers = [...m.players];
  if (m.gk) allPlayers.push(m.gk);

  if (m.showSub) {
    if (m.subMode === 'individual') {
      m.subs.forEach(s => { if (s.in && !allPlayers.includes(s.in)) allPlayers.push(s.in); });
    } else {
      m.swapPlayers.forEach(n => { if (!allPlayers.includes(n)) allPlayers.push(n); });
      if (m.swapGk && !allPlayers.includes(m.swapGk)) allPlayers.push(m.swapGk);
    }
  }
  allPlayers = [...new Set(allPlayers)].sort((a,b) => a - b);

  if (allPlayers.length === 0) {
    grid.innerHTML = '<span style="font-size:12px;color:#999;">å…ˆã«å‡ºå ´é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</span>';
    return;
  }

  Object.keys(m.scorers).forEach(k => {
    if (!allPlayers.includes(parseInt(k))) delete m.scorers[k];
  });

  grid.innerHTML = allPlayers.map(num => {
    const count = m.scorers[num] || 0;
    const cls = count > 0 ? 'scorer-chip selected' : 'scorer-chip';
    return `<div class="${cls}"
      onclick="toggleScorer(${matchId},${num})"
      ontouchstart="lpStart(event,${matchId},${num},'sc')"
      ontouchend="lpEnd(event)" ontouchmove="lpEnd(event)"
    >${num}${count > 1 ? `<span class="count">Ã—${count}</span>` : ''}</div>`;
  }).join('');
}

function toggleScorer(matchId, num) {
  if (lpFired) return;
  const m = getMatch(matchId);
  const c = m.scorers[num] || 0;
  m.scorers[num] = c + 1;
  renderScorers(matchId);
}

function resetScorer(matchId, num) {
  const m = getMatch(matchId);
  delete m.scorers[num];
  renderScorers(matchId);
}

// ========== Generate ==========
function generateOutput() {
  const date = document.getElementById('match-date').value;
  const type = document.querySelector('#match-type-options .chip.active')?.dataset.val || 'TM';
  const tournament = document.getElementById('tournament-name').value.trim();
  const opponent = document.getElementById('opponent').value.trim();
  const venue = document.getElementById('venue').value.trim();

  const d = new Date(date + 'T00:00:00');
  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const dateStr = `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}(${days[d.getDay()]})`;

  // Format string
  let fmtStr;
  const activePreset = document.querySelector('#format-presets .format-chip.active');
  if (activePreset && activePreset.dataset.min) {
    const min = activePreset.dataset.min;
    const per = activePreset.dataset.per;
    fmtStr = per === '2' ? `${min}åˆ†ãƒãƒ¼ãƒ•` : `${min}åˆ†Ã—${per}`;
  } else {
    fmtStr = `${formatMinutes}åˆ†Ã—${formatPeriods}`;
  }

  let lines = [];
  let header = `${dateStr} ${type}`;
  if (tournament) header += ` ${tournament}`;
  header += ` vs${opponent}`;
  lines.push(header);
  lines.push(`@${venue}`);
  lines.push(`è©¦åˆå½¢å¼${fmtStr}`);
  lines.push('');

  matches.forEach((m, i) => {
    const num = i + 1;

    // Starting lineup
    const starters = [...m.players].sort((a,b) => a - b);
    let playerStr = starters.join('.');
    if (m.gk !== null) {
      if (playerStr) playerStr += '.';
      playerStr += `GK${m.gk}`;
    }

    // Substitution
    if (m.showSub) {
      if (m.subMode === 'individual') {
        const validSubs = m.subs.filter(s => s.out !== null && s.in !== null);
        if (validSubs.length > 0) {
          const inPlayers = validSubs.map(s => s.in).sort((a,b) => a - b);
          let subStr = inPlayers.join('.');
          if (m.subGkChange) subStr += `.GK${m.subGkChange}`;
          playerStr += `â†’${subStr}`;
        }
      } else {
        if (m.swapPlayers.length > 0 || m.swapGk !== null) {
          const swapField = [...m.swapPlayers].sort((a,b) => a - b);
          let swapStr = swapField.join('.');
          if (m.swapGk !== null) {
            if (swapStr) swapStr += '.';
            swapStr += `GK${m.swapGk}`;
          }
          playerStr += `\nã€€ã€€ã€€ã€€â†’${swapStr}`;
        }
      }
    }

    const scoreUs = parseInt(document.getElementById(`score-us-${m.id}`).value) || 0;
    const scoreOpp = parseInt(document.getElementById(`score-opp-${m.id}`).value) || 0;

    // Result
    let result = '';
    if (scoreUs > scoreOpp) result = 'â—‹';
    else if (scoreUs === scoreOpp) result = 'â–³';
    else result = 'Ã—';

    // Scorers
    let scorerParts = [];
    Object.entries(m.scorers).forEach(([pNum, count]) => {
      for (let c = 0; c < count; c++) scorerParts.push(pNum);
    });
    const scorerStr = scorerParts.length > 0 ? scorerParts.join(',') : 'ãªã—';

    lines.push(`(${num}è©¦åˆç›®)`);
    lines.push(`å‡ºå ´é¸æ‰‹ï¼š${playerStr}`);
    lines.push(`ã‚¹ã‚³ã‚¢ï¼š${scoreUs}-${scoreOpp} ${result}`);
    lines.push(`å¾—ç‚¹è€…ï¼š${scorerStr}`);
    if (m.memo) lines.push(`ãƒ¡ãƒ¢ï¼š${m.memo}`);
    lines.push('');
  });

  const output = lines.join('\n').trimEnd();
  const outputArea = document.getElementById('output-area');
  outputArea.textContent = output;
  outputArea.style.display = 'block';
  document.getElementById('copy-btn').style.display = 'block';
  outputArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function copyOutput() {
  const text = document.getElementById('output-area').textContent;
  navigator.clipboard.writeText(text).then(() => showToast()).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    showToast();
  });
}

function showToast() {
  const t = document.createElement('div');
  t.className = 'copy-success';
  t.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 1600);
}

init();
</script>
</body>
</html>
